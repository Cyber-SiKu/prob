// to trigger a full tycho build please use 'gradle deleteFromClassPath completeInstall'
import org.apache.tools.ant.taskdefs.condition.Os

project.ext{

	targetRepositories = ["http://download.eclipse.org/releases/luna/",
                          "http://rodin-b-sharp.sourceforge.net/updates",
                          "http://rodin-b-sharp.sourceforge.net/core-updates"
                          ]

	groupID = "de.prob"
}

apply from: 'tycho_build.gradle'

// Local tasks


task bMotionStudioHelpCustumBuild(type: Exec){

	commandLine 'ant', '-f','de.bmotionstudio.help/customBuild.xml'
}

install.dependsOn bMotionStudioHelpCustumBuild

completeInstall.dependsOn bMotionStudioHelpCustumBuild

project(':de.prob.core') {

	repositories {
		maven {
		  name "cobra"
		  url "http://cobra.cs.uni-duesseldorf.de/artifactory/repo"
		}
	}


        def parser_version = '2.4.33-SNAPSHOT'

	dependencies {
	 compile group: "de.prob", name: "answerparser", version: parser_version , changing: true
	 compile group: "de.prob", name: "bparser", version: parser_version , changing: true
	 compile group: "de.prob", name: "cliparser", version: parser_version , changing: true
	 compile group: "de.prob", name: "ltlparser", version: parser_version , changing: true
	 compile group: "de.prob", name: "parserbase", version: parser_version , changing: true
	 compile group: "de.prob", name: "prologlib", version: parser_version , changing: true
	 compile group: "de.prob", name: "unicode", version: parser_version , changing: true
	 compile group: "de.prob", name: "theorymapping", version: parser_version , changing: true
	 compile 'commons-lang:commons-lang:2.6'
	}

}

project(':de.prob.ui') {
	repositories {
		maven {
		  name "cobra"
		  url "http://cobra.cs.uni-duesseldorf.de/artifactory/repo"
		}
	}
	dependencies {
	 	compile 'commons-codec:commons-codec:1.6'
	}
}


def download(address,target) {
	    def file = new FileOutputStream(target)
	    def out = new BufferedOutputStream(file)
	    out << new URL(address).openStream()
	    out.close()
}

task downloadCli << {
		def dir = workspacePath+'de.prob.core/prob/'
		delete file(dir)
	    new File(dir).mkdirs()

		['leopard64':'macos','linux32':'linux','linux64':'linux64','win32':'windows'].each {
		def n = it.getKey()

		def targetdir = dir+it.getValue()
		def targetzip = dir+"probcli_${n}.zip"
		def url = "http://nightly.cobra.cs.uni-duesseldorf.de/cli/probcli_${n}.zip"
		download(url,targetzip)
	    FileTree zip = zipTree(targetzip)
	    copy {
		   from zip
		   into targetdir
	    }
		delete file(targetzip)
	}

	def targetdir = dir+"windows/"
	def targetzip = targetdir+"windowslib32.zip"
	download("http://nightly.cobra.cs.uni-duesseldorf.de/cli/windowslib32.zip",targetzip)
	FileTree zip = zipTree(targetzip)
	    copy {
		   from zip
		   into targetdir
	    }
	delete file(targetzip)

}



task downloadCli2 ( type: Exec ) {

		def dir = workspacePath+'de.prob.core/prob/'
		delete file(dir)
	    new File(dir).mkdirs()

		['leopard64':'macos','linux32':'linux','linux64':'linux64','win32':'windows'].each {
		def n = it.getKey()

		def targetdir = dir+it.getValue()
		def targetzip = dir+"probcli_${n}.zip"
		def url = "http://nightly.cobra.cs.uni-duesseldorf.de/cli/probcli_${n}.zip"
		download(url,targetzip)
	    FileTree zip = zipTree(targetzip)
	    copy {
		   from zip
		   into targetdir
	    }
		delete file(targetzip)
	}

	def targetdir = dir+"windows/"
	def targetzip = targetdir+"windowslib32.zip"
	download("http://nightly.cobra.cs.uni-duesseldorf.de/cli/windowslib32.zip",targetzip)
	FileTree zip = zipTree(targetzip)
	    copy {
		   from zip
		   into targetdir
	    }
	delete file(targetzip)

	['leopard64':'macos','linux32':'linux','linux64':'linux64'].each {

		def n = it.getKey()
		targetdir = dir+it.getValue()

		download( "http://nightly.cobra.cs.uni-duesseldorf.de/cspm/cspm-"+n, targetdir+"/cspm" )
	}
	commandLine 'chmod', 'a+x', dir+'linux'+'/cspm', dir+'linux64'+'/cspm', dir+'macos'+'/cspm'
	//commandLine 'chmod', 'a+x', dir+'*'+'/cspm'

	download( "http://nightly.cobra.cs.uni-duesseldorf.de/cspm/cspm-windows", dir+"windows"+"/cspm.exe" )
}



completeInstall.dependsOn downloadCli
completeInstall.dependsOn subprojects.setClassPath

task deleteOldArtifacts(type: Delete) {
  	String updateSite = workspacePath+'updatesite'
	delete updateSite
}

task collectArtifacts(type:Copy) {
	    from workspacePath + groupID+'.repository/target/repository/'
	    into workspacePath + 'updatesite'
	    from workspacePath + "index.html"
	    into workspacePath + 'updatesite'
}
